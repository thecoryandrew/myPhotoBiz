@model MyPhotoBiz.ViewModels.PermissionsIndexViewModel
@{
    ViewBag.Title = "Permissions";
    ViewBag.SubTitle = "Users";
}

@section styles
{
}
<div class="container-fluid">

    @await Html.PartialAsync("~/Views/Shared/Partials/_PageTitle.cshtml")

    @if (TempData["SuccessMessage"] != null)
    {
        <div class="alert alert-success alert-dismissible fade show" role="alert">
            @TempData["SuccessMessage"]
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
    }

    @if (TempData["ErrorMessage"] != null)
    {
        <div class="alert alert-danger alert-dismissible fade show" role="alert">
            @TempData["ErrorMessage"]
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
    }

    <div class="row justify-content-center">
        <div class="col-xxl-10">

            <div class="d-flex align-items-sm-center flex-sm-row flex-column mb-3">
                <div class="flex-grow-1">
                    <h4 class="fs-xl mb-1">Manage Permissions</h4>
                    <p class="text-muted mb-0">Control access to features and functionality across your application.</p>
                </div>

                <div class="text-end">
                    <a href="javascript:void(0);" class="btn btn-success create-permission-btn">
                        <i class="ti ti-plus me-1"></i> Add New Permission
                    </a>
                </div>
            </div>

            <div data-table data-table-rows-per-page="8" class="card">
                <div class="card-header border-light justify-content-between">
                    <div class="d-flex gap-2">
                        <div class="app-search">
                            <input data-table-search type="search" class="form-control" placeholder="Search permissions...">
                            <i data-lucide="search" class="app-search-icon text-muted"></i>
                        </div>
                        <button data-table-delete-selected class="btn btn-danger d-none">Delete</button>
                    </div>

                    <!-- Records Per Page -->
                    <div>
                        <select data-table-set-rows-per-page class="form-select form-control my-1 my-md-0">
                            <option value="5">5</option>
                            <option value="8" selected>8</option>
                            <option value="10">10</option>
                            <option value="15">15</option>
                            <option value="20">20</option>
                        </select>
                    </div>
                </div>


                <div class="table-responsive">
                    <table class="table table-custom table-centered table-select table-hover w-100 mb-0">
                        <thead class="bg-light align-middle bg-opacity-25 thead-sm">
                            <tr class="text-uppercase fs-xxs">
                                <th data-table-sort="name">Name</th>
                                <th>Assign To</th>
                                <th data-table-sort="created">Created Date</th>
                                <th data-table-sort="users">Users</th>
                                <th class="text-center">Actions</th>
                            </tr>
                        </thead>
                        <tbody>
                            @if (Model?.Permissions?.Any() == true)
                            {
                                @foreach (var permission in Model.Permissions)
                                {
                                    <tr data-permission-id="@permission.Id">
                                        <td data-sort="name">@permission.Name</td>
                                        <td>
                                            @if (permission.AssignedRoles?.Any() == true)
                                            {
                                                @foreach (var role in permission.AssignedRoles)
                                                {
                                                    var badgeClass = role switch
                                                    {
                                                        "Admin" => "bg-primary-subtle text-primary",
                                                        "Client" => "bg-info-subtle text-info",
                                                        "Photographer" => "bg-success-subtle text-success",
                                                        _ => "bg-secondary-subtle text-secondary"
                                                    };
                                                    <span class="badge @badgeClass badge-label fs-xxs fw-semibold me-1">@role</span>
                                                }
                                            }
                                            else
                                            {
                                                <span class="text-muted">No roles assigned</span>
                                            }
                                        </td>
                                        <td data-sort="created">
                                            @permission.CreatedDate.ToString("dd MMM yyyy"),
                                            <span class="text-muted">@permission.CreatedDate.ToString("h:mm tt")</span>
                                        </td>
                                        <td data-sort="users">@permission.UserCount</td>
                                        <td class="text-center">
                                            <a href="javascript:void(0);" class="btn btn-light btn-icon btn-sm rounded-circle view-permission" data-permission-id="@permission.Id" title="View Details">
                                                <i class="ti ti-eye fs-lg"></i>
                                            </a>
                                            <a href="javascript:void(0);" class="btn btn-light btn-icon btn-sm rounded-circle edit-permission" data-permission-id="@permission.Id" title="Edit Permission">
                                                <i class="ti ti-edit fs-lg"></i>
                                            </a>
                                            <a href="javascript:void(0);" class="btn btn-light btn-icon btn-sm rounded-circle delete-permission" data-permission-id="@permission.Id" data-permission-name="@permission.Name" title="Delete Permission">
                                                <i class="ti ti-trash fs-lg"></i>
                                            </a>
                                        </td>
                                    </tr>
                                }
                            }
                            else
                            {
                                <tr>
                                    <td colspan="5" class="text-center py-5">
                                        <p class="text-muted mb-3">No permissions found. Create your first permission to get started.</p>
                                        <button type="button" class="btn btn-primary create-permission-btn">
                                            <i class="ti ti-plus me-1"></i> Create First Permission
                                        </button>
                                    </td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
                <div class="card-footer border-0">
                    <div class="d-flex justify-content-between align-items-center">
                        <div data-table-pagination-info></div>
                        <div data-table-pagination></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

</div>

@Html.AntiForgeryToken()

@section scripts
{
<script src="~/js/pages/custom-table.js"></script>
<script>
    function showToast(message, type = 'success') {
        var container = document.getElementById('toastContainer');
        if (!container) {
            container = document.createElement('div');
            container.id = 'toastContainer';
            container.className = 'position-fixed top-0 end-0 p-3';
            container.style.zIndex = 9999;
            document.body.appendChild(container);
        }

        var toast = document.createElement('div');
        toast.className = `toast align-items-center text-bg-${type === 'danger' ? 'danger' : type} border-0 show`;
        toast.role = 'alert';
        toast.innerHTML = `<div class="d-flex"><div class="toast-body">${message}</div><button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button></div>`;
        container.appendChild(toast);
        var bsToast = new bootstrap.Toast(toast, { delay: 4000 });
        bsToast.show();
        toast.addEventListener('hidden.bs.toast', function () {
            toast.remove();
        });
    }

    // Create Permission
    document.addEventListener('click', function (e) {
        const createBtn = e.target.closest('.create-permission-btn');
        if (createBtn) {
            e.preventDefault();
            fetch('@Url.Action("Create", "Permissions")')
                .then(res => res.text())
                .then(html => {
                    const existing = document.getElementById('createPermissionModal');
                    if (existing) existing.remove();
                    document.body.insertAdjacentHTML('beforeend', html);
                    new bootstrap.Modal(document.getElementById('createPermissionModal')).show();
                })
                .catch(err => {
                    console.error('Error:', err);
                    showToast('Failed to load create form', 'danger');
                });
        }

        // View Permission
        const viewBtn = e.target.closest('.view-permission');
        if (viewBtn) {
            e.preventDefault();
            const id = viewBtn.dataset.permissionId;
            fetch(`@Url.Action("Details", "Permissions")/${id}`)
                .then(res => res.text())
                .then(html => {
                    const existing = document.getElementById('permissionDetailsModal');
                    if (existing) existing.remove();
                    document.body.insertAdjacentHTML('beforeend', html);
                    new bootstrap.Modal(document.getElementById('permissionDetailsModal')).show();
                })
                .catch(err => {
                    console.error('Error:', err);
                    showToast('Failed to load permission details', 'danger');
                });
        }

        // Edit Permission
        const editBtn = e.target.closest('.edit-permission');
        if (editBtn) {
            e.preventDefault();
            const id = editBtn.dataset.permissionId;
            fetch(`@Url.Action("Edit", "Permissions")/${id}`)
                .then(res => res.text())
                .then(html => {
                    const existing = document.getElementById('editPermissionModal');
                    if (existing) existing.remove();
                    document.body.insertAdjacentHTML('beforeend', html);
                    new bootstrap.Modal(document.getElementById('editPermissionModal')).show();
                })
                .catch(err => {
                    console.error('Error:', err);
                    showToast('Failed to load edit form', 'danger');
                });
        }

        // Delete Permission
        const deleteBtn = e.target.closest('.delete-permission');
        if (deleteBtn) {
            e.preventDefault();
            const id = deleteBtn.dataset.permissionId;
            const name = deleteBtn.dataset.permissionName;
            if (confirm(`Are you sure you want to delete the permission "${name}"?`)) {
                const formData = new FormData();
                formData.append('__RequestVerificationToken', document.querySelector('input[name="__RequestVerificationToken"]')?.value);

                fetch(`@Url.Action("Delete", "Permissions")/${id}`, {
                    method: 'POST',
                    body: formData
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        const row = document.querySelector(`tr[data-permission-id='${id}']`);
                        if (row) row.remove();
                        showToast(data.message || 'Permission deleted', 'success');
                    } else {
                        showToast(data.message || 'Error deleting permission', 'danger');
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    showToast('An error occurred while deleting the permission.', 'danger');
                });
            }
        }
    });
</script>
}
